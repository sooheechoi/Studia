<!DOCTYPE HTML>
<html>
	<head>
		<title>Studia - My Page</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="css/main.css" />
		<link rel="stylesheet" href="css/fontawesome-all.min.css" />
		<link rel="stylesheet" href="css/responsive.css" />
		<link rel="stylesheet" href="css/sidebar-fixed.css" />
		<link rel="stylesheet" href="css/menu-toggle.css" />
		<link rel="stylesheet" href="css/header-unified-v2.css" />		<link rel="stylesheet" href="css/dark-mode.css" />
		<link rel="stylesheet" href="/static/css/header-override.css">
		<link rel="stylesheet" href="css/main-responsive.css" />		<style>
			
		.profile-header {
				background: #f56a6a;
				color: white;
				padding: 40px;
				border-radius: 10px;
				text-align: center;
				margin-bottom: 30px;
			}
			.profile-avatar {
				width: 120px;
				height: 120px;
				border-radius: 50%;
				background: white;
				margin: 0 auto 20px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 3em;
				color: #f56a6a;
				overflow: hidden;
				box-shadow: 0 5px 15px rgba(0,0,0,0.2);
				transition: transform 0.3s;
			}
			.profile-avatar:hover {
				transform: scale(1.05);
			}
			.profile-avatar img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 20px;
				margin-bottom: 30px;
			}
			.stat-box {
				background: #f9f9f9;
				padding: 20px;
				border-radius: 10px;
				text-align: center;
			}
			.stat-box h3 {
				margin: 0 0 10px 0;
				color: #f56a6a;
			}
			.achievement-list {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
				gap: 15px;
			}
			.achievement {
				background: white;
				border: 2px solid #e0e0e0;
				padding: 15px;
				border-radius: 10px;
				text-align: center;
				transition: all 0.3s;
			}
			.achievement.earned {
				border-color: #f56a6a;
				background: #ffe6e6;
			}
			.achievement-icon {
				font-size: 2em;
				margin-bottom: 10px;
			}
			.recent-activity {
				background: #f9f9f9;
				padding: 20px;
				border-radius: 10px;
			}
			.activity-item {
				padding: 15px 0;
				border-bottom: 1px solid #e0e0e0;
			}
			.activity-item:last-child {
				border-bottom: none;
			}
			.settings-section {
				background: white;
				padding: 30px;
				border-radius: 10px;
				margin-top: 30px;
			}
		
                  /* 아이콘 컨테이너 중앙 정렬 */
                  .menu-toggle-btn i {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        width: 100%;
                        height: 100%;
                        position: relative;
                  }
                  
                  /* 햄버거 메뉴 라인 위치 조정 */
                  .menu-toggle-btn span,
                  .menu-toggle-btn i::before,
                  .menu-toggle-btn i::after {
                        position: absolute;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 20px;
                        height: 2px;
                        background-color: white;
                        transition: all 0.3s ease;
                  }
                  
                  .menu-toggle-btn span {
                        top: 50%;
                        transform: translate(-50%, -50%);
                  }
                  
                  .menu-toggle-btn i::before {
                        content: '';
                        top: calc(50% - 6px);
                  }
                  
                  .menu-toggle-btn i::after {
                        content: '';
                        top: calc(50% + 4px);
                  }
                  
                  /* 사이드바가 열려있을 때 X 모양으로 변형 */
                  body:not(.sidebar-inactive) .menu-toggle-btn span {
                        opacity: 0;
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::before {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(45deg);
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::after {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                  }
                
                  /* 아이콘 컨테이너 중앙 정렬 */
                  .menu-toggle-btn i {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        width: 100%;
                        height: 100%;
                        position: relative;
                  }
                  
                  /* 햄버거 메뉴 라인 위치 조정 */
                  .menu-toggle-btn span,
                  .menu-toggle-btn i::before,
                  .menu-toggle-btn i::after {
                        position: absolute;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 20px;
                        height: 2px;
                        background-color: white;
                        transition: all 0.3s ease;
                  }
                  
                  .menu-toggle-btn span {
                        top: 50%;
                        transform: translate(-50%, -50%);
                  }
                  
                  .menu-toggle-btn i::before {
                        content: '';
                        top: calc(50% - 6px);
                  }
                  
                  .menu-toggle-btn i::after {
                        content: '';
                        top: calc(50% + 4px);
                  }
                  
                  /* 사이드바가 열려있을 때 X 모양으로 변형 */
                  body:not(.sidebar-inactive) .menu-toggle-btn span {
                        opacity: 0;
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::before {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(45deg);
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::after {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                  }
                </style>
	</head>
	<body class="is-preload">
		<!-- Menu Toggle Button -->
		<button class="menu-toggle-btn" onclick="toggleSidebar()">
			<i><span></span></i>
		</button>
		
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					                <!-- Header -->
                <header id="header">
                    <a href="index.html" class="logo">
                        <strong style="font-size: 2em;">Studia</strong>
                    </a>
                    <ul class="icons header-user-info">
                        <li><span id="userWelcome">Welcome!</span></li>
                        <li><a href="#" onclick="logout()" class="button small logout-btn">Logout</a></li>
                    </ul>
                </header>

					<!-- Content -->
					<section>
						<!-- Profile Header -->
						<div class="profile-header">
							<div class="profile-avatar" id="profileAvatar" style="position: relative; cursor: pointer;" onclick="document.getElementById('avatarInput').click()">
								<span class="icon fa-user"></span>
								<div style="position: absolute; bottom: 0; right: 0; background: #667eea; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white;">
									<i class="fas fa-camera" style="font-size: 0.8em;"></i>
								</div>
							</div>
							<input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(event)">
							<h1 id="profileName">User</h1>
							<p id="profileEmail">user@example.com</p>
							<p>Member since <span id="memberSince">January 2025</span></p>
						</div>

						<!-- Statistics -->
						<h2>Your Learning Statistics</h2>
						<div class="stats-grid">
							<div class="stat-box">
								<h3 id="totalStudyTime">0h</h3>
								<p>Total Study Time</p>
							</div>
							<div class="stat-box">
								<h3 id="materialsUploaded">0</h3>
								<p>Materials Uploaded</p>
							</div>
							<div class="stat-box">
								<h3 id="quizzesCompleted">0</h3>
								<p>Quizzes Completed</p>
							</div>
							<div class="stat-box">
								<h3 id="avgQuizScore">0%</h3>
								<p>Average Quiz Score</p>
							</div>
						</div>

						<!-- Achievements -->
						<h2>Achievements</h2>
						<div class="achievement-list">
							<div class="achievement" id="firstUpload">
								<div class="achievement-icon">📚</div>
								<h4>First Upload</h4>
								<p>Upload your first study material</p>
							</div>
							<div class="achievement" id="quizMaster">
								<div class="achievement-icon">🎯</div>
								<h4>Quiz Master</h4>
								<p>Complete 10 quizzes</p>
							</div>
							<div class="achievement" id="perfectScore">
								<div class="achievement-icon">💯</div>
								<h4>Perfect Score</h4>
								<p>Get 100% on a quiz</p>
							</div>
							<div class="achievement" id="weekStreak">
								<div class="achievement-icon">🔥</div>
								<h4>Week Streak</h4>
								<p>Study for 7 days in a row</p>
							</div>
							<div class="achievement" id="earlyBird">
								<div class="achievement-icon">🌅</div>
								<h4>Early Bird</h4>
								<p>Study before 7 AM</p>
							</div>
							<div class="achievement" id="nightOwl">
								<div class="achievement-icon">🦉</div>
								<h4>Night Owl</h4>
								<p>Study after 11 PM</p>
							</div>
						</div>

						<!-- Recent Activity -->
						<h2>Recent Activity</h2>
						<div class="recent-activity">
							<div id="activityList">
								<!-- Activity items will be loaded here -->
							</div>
						</div>

						<!-- Settings -->
						<div class="settings-section">
							<h2>Settings</h2>
							<form id="settingsForm">
								<div class="row gtr-uniform">
									<div class="col-6 col-12-xsmall">
										<input type="text" id="userName" placeholder="Name" />
									</div>
									<div class="col-6 col-12-xsmall">
										<input type="email" id="userEmail" placeholder="Email" readonly />
									</div>
									<div class="col-12">
										<h3>Change Password</h3>
									</div>
									<div class="col-6 col-12-xsmall">
										<input type="password" id="currentPassword" placeholder="Current Password" />
									</div>
									<div class="col-6 col-12-xsmall">
										<input type="password" id="newPassword" placeholder="New Password" />
									</div>
									<div class="col-12">
										<h3>Preferences</h3>
									</div>
									<div class="col-12">
										<input type="checkbox" id="emailNotifications" name="emailNotifications">
										<label for="emailNotifications">Email notifications for new quizzes</label>
									</div>
									<div class="col-12">
										<input type="checkbox" id="darkMode" name="darkMode">
										<label for="darkMode">Dark mode (coming soon)</label>
									</div>
									<div class="col-12">
										<ul class="actions">
											<li><button type="submit" class="button primary">Save Changes</button></li>
											<li><button type="button" class="button" onclick="logout()">Log Out</button></li>
										</ul>
									</div>
									<div class="col-12" style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
										<h3 style="color: #f44336;">Danger Zone</h3>
										<p>Once you delete your account, there is no going back. Please be certain.</p>
										<button type="button" class="button" style="background: #f44336; color: white;" onclick="deleteAccount()">Delete Account</button>
									</div>
								</div>
							</form>
						</div>
					</section>
				</div>
			</div>

			<!-- Sidebar -->
			<div id="sidebar">
				<div class="inner">
					<!-- Menu -->
					<nav id="menu">
						<header class="major">
							<h2>Menu</h2>
						</header>
						<ul>
							<li><a href="index.html">Main</a></li>
							<li><a href="summary.html">Summary</a></li>
							<li><a href="quiz.html">Quiz</a></li>
							<li><a href="plan.html">Study Plan</a></li>
							<li><a href="dashboard.html">Dashboard</a></li>
							<li><a href="leaderboard.html">Leaderboard</a></li>
							<li><a href="friends.html">Friends</a></li>
							<li><a href="profile.html">My Page</a></li>										
						</ul>
					</nav>

					<!-- Section -->
					<section>
						<header class="major">
							<h2>Get in touch</h2>
						</header>
						<ul class="contact">
							<li class="icon solid fa-envelope"><a href="#">sooheechoi@sju.ac.kr</a></li>
							<li class="icon solid fa-home">209 Neungdong-ro, Gwangjin-gu, Seoul, <br />
							05006, Republic of Korea</li>
						</ul>
					</section>

					<!-- Footer -->
					<footer id="footer"></footer>
				</div>
			</div>
		</div>

		<!-- Scripts -->
		<script src="js/jquery.min.js"></script>
		<script src="js/browser.min.js"></script>
		<script src="js/breakpoints.min.js"></script>
		<script src="js/util.js"></script>
		<script src="js/main.js"></script>
		<script src="assets/js/api.js"></script>
		<script src="/static/js/header-username.js"></script>
		<script src="js/sidebar-toggle-global.js"></script>
		<script src="js/dark-mode.js"></script>
		<script src="js/sidebar-state.js"></script>

		<script>
			// Toggle Sidebar Function
			function toggleSidebar() {
				const sidebar = document.getElementById('sidebar');
				sidebar.classList.toggle('inactive');
				document.body.classList.toggle('sidebar-inactive');
			}
			
			// 페이지 로드 시
			document.addEventListener('DOMContentLoaded', async function() {
				// Set initial sidebar state - always start closed
				const sidebar = document.getElementById('sidebar');
				sidebar.classList.add('inactive');
				document.body.classList.add('sidebar-inactive');

				if (!checkAuth()) {
					alert('Please login first');
					window.location.href = '/';
					return;
				}

				updateHeader();
				loadProfile();
				loadActivity();
				setupSettingsForm();
			});

			function updateHeader() {
				const username = TokenManager.getUsername();
				const userWelcome = document.getElementById('userWelcome');
				if (userWelcome) {
					userWelcome.textContent = `Welcome, ${username || 'User'}!`;
					userWelcome.setAttribute('data-username', username || 'User');
				}
			}

			function logout() {
				if (confirm('Are you sure you want to log out?')) {
					API.auth.logout();
				}
			}

			async function deleteAccount() {
				const confirmMsg = 'Are you absolutely sure you want to delete your account?\n\n' +
					'This action cannot be undone. All your data will be permanently deleted.\n\n' +
					'Type "DELETE" to confirm:';
				
				const userInput = prompt(confirmMsg);
				
				if (userInput === 'DELETE') {
					try {
						await API.user.deleteAccount();
						alert('Your account has been successfully deleted.');
						TokenManager.removeToken();
						TokenManager.removeUsername();
						window.location.href = '/';
					} catch (error) {
						alert('Failed to delete account: ' + error.message);
					}
				} else if (userInput) {
					alert('Account deletion cancelled. You must type "DELETE" to confirm.');
				}
			}

			async function loadProfile() {
				try {
					// Load user profile and statistics
					const username = TokenManager.getUsername() || 'User';
					const email = localStorage.getItem('userEmail') || 'user@example.com';
					
					// Update profile header
					document.getElementById('profileName').textContent = username;
					document.getElementById('profileEmail').textContent = email;
					
					// Load profile picture if exists
					const profilePic = localStorage.getItem('profilePicture');
					if (profilePic) {
						document.getElementById('profileAvatar').innerHTML = `<img src="${profilePic}" alt="Profile">`;
					} else {
						document.getElementById('profileAvatar').innerHTML = `
							<span class="icon fa-user"></span>
							<div style="position: absolute; bottom: 0; right: 0; background: #667eea; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white;">
								<i class="fas fa-camera" style="font-size: 0.8em;"></i>
							</div>
						`;
					}
					
					// Load statistics
					try {
						const response = await fetch('http://localhost:8080/api/stats/overview', {
							headers: {
								'Authorization': `Bearer ${TokenManager.getToken()}`
							}
						});
						
						if (response.ok) {
							const stats = await response.json();
							document.getElementById('totalStudyTime').textContent = formatStudyTime(stats.totalStudyTime || 0);
							document.getElementById('materialsUploaded').textContent = stats.totalMaterials || 0;
							document.getElementById('quizzesCompleted').textContent = stats.completedQuizzes || 0;
							document.getElementById('avgQuizScore').textContent = (stats.averageScore || 0) + '%';
							updateAchievements(stats);
						}
					} catch (error) {
						console.log('Stats API not available, using defaults');
					}
					
					// Update settings form
					document.getElementById('userName').value = username;
					document.getElementById('userEmail').value = email;
				} catch (error) {
					console.error('Failed to load profile:', error);
				}
			}

			function formatStudyTime(minutes) {
				const hours = Math.floor(minutes / 60);
				const mins = minutes % 60;
				return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
			}

			function updateAchievements(stats) {
				// Mark earned achievements
				if (stats.totalMaterials > 0) {
					document.getElementById('firstUpload').classList.add('earned');
				}
				if (stats.completedQuizzes >= 10) {
					document.getElementById('quizMaster').classList.add('earned');
				}
				if (stats.hasPerfectScore) {
					document.getElementById('perfectScore').classList.add('earned');
				}
				if (stats.studyStreak >= 7) {
					document.getElementById('weekStreak').classList.add('earned');
				}
			}

			async function loadActivity() {
				const activityList = document.getElementById('activityList');
				
				// Mock activity data - in real app, this would come from API
				const activities = [
					{ type: 'quiz', text: 'Completed quiz with 85% score', time: '2 hours ago' },
					{ type: 'upload', text: 'Uploaded "Chapter 5 Notes.pdf"', time: '1 day ago' },
					{ type: 'study', text: 'Studied for 45 minutes', time: '2 days ago' },
					{ type: 'quiz', text: 'Created 10 questions from summary', time: '3 days ago' }
				];
				
				activityList.innerHTML = activities.map(activity => `
					<div class="activity-item">
						<strong>${activity.text}</strong>
						<br>
						<small>${activity.time}</small>
					</div>
				`).join('');
			}

			function setupSettingsForm() {
				const form = document.getElementById('settingsForm');
				form.addEventListener('submit', async (e) => {
					e.preventDefault();
					
					const newName = document.getElementById('userName').value;
					const currentPassword = document.getElementById('currentPassword').value;
					const newPassword = document.getElementById('newPassword').value;
					
					// Update name in localStorage
					if (newName) {
						TokenManager.setUsername(newName);
					}
					
					// Handle password change
					if (currentPassword && newPassword) {
						// This would need an API endpoint
						alert('Password change feature coming soon!');
					}
					
					alert('Settings saved!');
					loadProfile(); // Reload profile to show changes
				});
			}
			
			// Profile picture upload
			function uploadAvatar(event) {
				const file = event.target.files[0];
				if (!file) return;
				
				// Check file size (max 5MB)
				if (file.size > 5 * 1024 * 1024) {
					alert('File size must be less than 5MB');
					return;
				}
				
				// Check file type
				if (!file.type.startsWith('image/')) {
					alert('Please select an image file');
					return;
				}
				
				const reader = new FileReader();
				reader.onload = function(e) {
					// Compress image if needed
					compressImage(e.target.result, 300, 300, (compressedImage) => {
						// Store in localStorage (for demo - in production, upload to server)
						localStorage.setItem('profilePicture', compressedImage);
						
						// Update UI
						document.getElementById('profileAvatar').innerHTML = `<img src="${compressedImage}" alt="Profile">`;
						
						// Show success message
						showNotification('Profile picture updated!');
					});
				};
				reader.readAsDataURL(file);
			}
			
			// Image compression function
			function compressImage(dataUrl, maxWidth, maxHeight, callback) {
				const img = new Image();
				img.onload = function() {
					const canvas = document.createElement('canvas');
					let width = img.width;
					let height = img.height;
					
					// Calculate new dimensions
					if (width > height) {
						if (width > maxWidth) {
							height *= maxWidth / width;
							width = maxWidth;
						}
					} else {
						if (height > maxHeight) {
							width *= maxHeight / height;
							height = maxHeight;
						}
					}
					
					canvas.width = width;
					canvas.height = height;
					
					const ctx = canvas.getContext('2d');
					ctx.drawImage(img, 0, 0, width, height);
					
					// Return compressed image
					callback(canvas.toDataURL('image/jpeg', 0.8));
				};
				img.src = dataUrl;
			}
			
			// Notification function
			function showNotification(message, type = 'success') {
				const notification = document.createElement('div');
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					padding: 15px 25px;
					background: ${type === 'success' ? '#4caf50' : '#f44336'};
					color: white;
					border-radius: 8px;
					box-shadow: 0 4px 12px rgba(0,0,0,0.15);
					z-index: 1000;
					animation: slideIn 0.3s ease;
				`;
				notification.textContent = message;
				
				document.body.appendChild(notification);
				
				setTimeout(() => {
					notification.style.animation = 'slideOut 0.3s ease';
					setTimeout(() => notification.remove(), 300);
				}, 3000);
			}
		</script>
		</body>
</html>
