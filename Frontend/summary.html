<!DOCTYPE HTML>
<html>
	<head>
		<title>Studia - Summary</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="css/main.css" />
		<link rel="stylesheet" href="css/fontawesome-all.min.css" />
		<link rel="stylesheet" href="css/responsive.css" />
		<link rel="stylesheet" href="css/sidebar-fixed.css" />
		<link rel="stylesheet" href="css/menu-toggle.css" />
		<link rel="stylesheet" href="css/header-final.css?v=1749757770" />
		<link rel="stylesheet" href="css/main-responsive.css" />
		<link rel="stylesheet" href="css/dark-mode.css" />
		<style>
			/* Modern Card Design */
			.material-card {
				background: white;
				border-radius: 12px;
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
				padding: 25px;
				margin-bottom: 20px;
				transition: all 0.4s ease;
				border: 1px solid #f0f0f0;
			}
			.material-card:hover {
				box-shadow: 0 4px 20px rgba(0,0,0,0.12);
				transform: translateY(-2px);
			}
			
			/* Upload Area Redesign */
			.upload-container {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				border-radius: 16px;
				padding: 40px;
				text-align: center;
				margin-bottom: 40px;
				color: white;
			}
			.upload-area {
				background: rgba(255,255,255,0.95);
				border: 2px dashed rgba(102, 126, 234, 0.5);
				border-radius: 12px;
				padding: 40px;
				cursor: pointer;
				transition: all 0.3s;
				color: #333;
			}
			.upload-area:hover {
				background: white;
				border-color: #667eea;
				transform: scale(1.02);
			}
			.upload-area.dragover {
				background: rgba(102, 126, 234, 0.1);
				border-color: #667eea;
			}
			
			/* Material Header */
			.material-header {
				display: flex;
				justify-content: space-between;
				align-items: start;
				margin-bottom: 20px;
			}
			.material-title {
				font-size: 1.4em;
				font-weight: 600;
				color: #2c3e50;
				margin: 0;
			}
			.material-meta {
				display: flex;
				gap: 20px;
				margin-top: 10px;
				color: #7f8c8d;
				font-size: 0.9em;
			}
			.material-meta span {
				display: flex;
				align-items: center;
				gap: 5px;
			}
			
			/* Status Badge */
			.status-badge {
				display: inline-flex;
				align-items: center;
				padding: 6px 12px;
				border-radius: 20px;
				font-size: 0.85em;
				font-weight: 500;
			}
			.status-processing {
				background: #fff4e5;
				color: #ff9800;
			}
			.status-completed {
				background: #e8f5e9;
				color: #4caf50;
			}
			.status-error {
				background: #ffebee;
				color: #f44336;
			}
			
			/* Summary Section */
			.summary-section {
				background: #f8f9fa;
				border-radius: 8px;
				padding: 20px;
				margin: 20px 0;
			}
			.summary-section h4 {
				color: #667eea;
				margin-top: 0;
				margin-bottom: 15px;
				font-size: 1.1em;
			}
			.summary-content {
				line-height: 1.6;
				color: #495057;
				white-space: pre-wrap;
				word-wrap: break-word;
				word-break: break-word;
			}
			
			/* Key Points */
			.key-points {
				list-style: none;
				padding: 0;
			}
			.key-points li {
				position: relative;
				padding-left: 30px;
				margin-bottom: 12px;
				line-height: 1.5;
			}
			.key-points li:before {
				content: "✓";
				position: absolute;
				left: 0;
				color: #4caf50;
				font-weight: bold;
			}
			
			/* Action Buttons */
			.material-actions {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}
			.action-btn {
				padding: 10px 20px;
				border: none;
				border-radius: 8px;
				font-size: 0.9em;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.3s;
				text-decoration: none;
				display: inline-flex;
				align-items: center;
				gap: 8px;
			}
			.btn-primary {
				background: #667eea;
				color: white;
			}
			.btn-primary:hover {
				background: #5a67d8;
				transform: translateY(-1px);
			}
			.btn-secondary {
				background: #e9ecef;
				color: #495057;
			}
			.btn-secondary:hover {
				background: #dee2e6;
			}
			.btn-danger {
				background: #ffebee;
				color: #f44336;
			}
			.btn-danger:hover {
				background: #ffcdd2;
			}
			
			/* Progress Indicator */
			.progress-bar {
				width: 100%;
				height: 8px;
				background: #e9ecef;
				border-radius: 4px;
				overflow: hidden;
				margin-top: 20px;
			}
			.progress-fill {
				height: 100%;
				background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
				transition: width 0.3s ease;
				width: 0%;
			}
			
			/* Empty State */
			.empty-state {
				text-align: center;
				padding: 60px 20px;
				color: #6c757d;
			}
			.empty-state i {
				font-size: 4em;
				color: #dee2e6;
				margin-bottom: 20px;
			}
			
			/* Loading Spinner */
			.spinner {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 3px solid rgba(0,0,0,.1);
				border-radius: 50%;
				border-top-color: #667eea;
				animation: spin 1s ease-in-out infinite;
			}
			@keyframes spin {
				to { transform: rotate(360deg); }
			}
		</style>
	</head>
	<body class="is-preload">
		<!-- Menu Toggle Button -->
		<button class="menu-toggle-btn" onclick="toggleSidebar()">
			<i><span></span></i>
		</button>
		
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					                <!-- Header -->
                <header id="header">
                    <a href="index.html" class="logo">
                        <strong style="font-size: 2em;">Studia</strong>
                    </a>
                    <ul class="icons header-user-info">
                        <li><span id="userWelcome" data-username="">Welcome!</span></li>
                        <li><a href="#" onclick="logout()" class="button small logout-btn">Logout</a></li>
                    </ul>
                </header>

					<!-- Content -->
					<section>
						<header class="main">
							<h1>Study Materials</h1>
							<p>Upload your study materials and get AI-powered summaries instantly</p>
						</header>

						<!-- Filter Section -->
						<div style="margin-bottom: 30px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
							<div style="flex: 1; min-width: 200px;">
								<label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Class:</label>
								<select id="classFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
									<option value="">All Classes</option>
								</select>
							</div>
							<div style="flex: 1; min-width: 200px;">
								<label style="display: block; margin-bottom: 5px; font-weight: 500;">Search:</label>
								<input type="text" id="searchFilter" placeholder="Search materials..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
							</div>
						</div>

						<!-- Upload Area -->
						<div class="upload-container">
							<h2 style="margin-top: 0; color: white;">Upload New Material</h2>
							<div class="upload-area" id="uploadArea">
								<i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #667eea; margin-bottom: 20px; display: block;"></i>
								<h3 style="margin: 0 0 10px 0; color: #333;">Drop files here or click to browse</h3>
								<p style="margin: 0; color: #666;">Supported formats: PDF, DOCX, PPTX, TXT (Max 100MB)</p>
								<input type="file" id="fileInput" style="display: none;" accept=".pdf,.docx,.pptx,.txt" multiple />
							</div>
							<div class="progress-bar" id="progressBar" style="display: none;">
								<div class="progress-fill" id="progressFill"></div>
							</div>
						</div>

						<!-- Materials List -->
						<div id="materialsContainer">
							<div class="empty-state">
								<i class="fas fa-folder-open"></i>
								<h3>No materials yet</h3>
								<p>Upload your first study material to get started!</p>
							</div>
						</div>
					</section>
				</div>
			</div>

			<!-- Sidebar -->
			<div id="sidebar">
				<div class="inner">
					<!-- Menu -->
					<nav id="menu">
						<header class="major">
							<h2>Menu</h2>
						</header>
						<ul>
							<li><a href="index.html">Main</a></li>
							<li><a href="summary.html">Summary</a></li>
							<li><a href="quiz.html">Quiz</a></li>
							<li><a href="plan.html">Study Plan</a></li>
							<li><a href="dashboard.html">Dashboard</a></li>
							<li><a href="leaderboard.html">Leaderboard</a></li>
							<li><a href="friends.html">Friends</a></li>
							<li><a href="profile.html">My Page</a></li>										
						</ul>
					</nav>

					<!-- Section -->
					<section>
						<header class="major">
							<h2>Quick Tips</h2>
						</header>
						<p><strong>Supported Formats:</strong><br>PDF, DOCX, PPTX, TXT files up to 100MB</p>
						<p><strong>AI Features:</strong><br>• Auto-summarization<br>• Key points extraction<br>• Quiz generation</p>
					</section>

					<!-- Footer -->
					<footer id="footer"></footer>
				</div>
			</div>
		</div>

		<!-- Scripts -->
		<script src="js/jquery.min.js"></script>
		<script src="js/browser.min.js"></script>
		<script src="js/breakpoints.min.js"></script>
		<script src="js/util.js"></script>
		<script src="js/main.js"></script>
		<!-- API script must be loaded first -->
		<script src="assets/js/api.js"></script>
		<script src="js/header-username.js"></script>
		<script src="js/sidebar-toggle-global.js"></script>
		<script src="js/sidebar-state.js"></script>
		<script src="js/dark-mode.js"></script>
		<script src="js/pdf-viewer.js"></script>
		<script src="js/modal-manager.js"></script>

		<script>
			// Wait for all scripts to load
			window.addEventListener('load', function() {
				console.log('Window loaded, checking API...');
				console.log('API object:', window.API);
				console.log('apiClient object:', window.apiClient);
				console.log('checkAuth function:', window.checkAuth);
				
				if (!window.API || !window.checkAuth) {
					console.error('API not loaded properly!');
					alert('Failed to load API. Please refresh the page.');
					return;
				}
				
				// Initialize page
				initializePage();
			});
			
			// Page initialization
			async function initializePage() {
				console.log('Initializing page...');

				if (!checkAuth()) {
					alert('Please login first');
					window.location.href = '/';
					return;
				}

				updateHeader();
				await loadMaterials();
				setupUploadArea();
			}

			function updateHeader() {
                const username = TokenManager.getUsername();
                const userWelcome = document.getElementById('userWelcome');
                userWelcome.textContent = `Welcome, ${username || 'User'}!`;
                userWelcome.setAttribute('data-username', username || 'User');
            }

			function logout() {
				API.auth.logout();
			}

			function setupUploadArea() {
				console.log('Setting up upload area...');
				const uploadArea = document.getElementById('uploadArea');
				const fileInput = document.getElementById('fileInput');
				const progressBar = document.getElementById('progressBar');
				const progressFill = document.getElementById('progressFill');

				if (!uploadArea || !fileInput) {
					console.error('Upload area or file input not found!');
					return;
				}

				uploadArea.addEventListener('click', () => {
					console.log('Upload area clicked');
					fileInput.click();
				});

				fileInput.addEventListener('change', (e) => {
					console.log('File input changed');
					const files = Array.from(e.target.files);
					console.log('Selected files:', files);
					if (files.length > 0) {
						uploadFiles(files);
					}
				});

				// Drag and drop
				uploadArea.addEventListener('dragover', (e) => {
					e.preventDefault();
					uploadArea.classList.add('dragover');
				});

				uploadArea.addEventListener('dragleave', () => {
					uploadArea.classList.remove('dragover');
				});

				uploadArea.addEventListener('drop', (e) => {
					e.preventDefault();
					uploadArea.classList.remove('dragover');
					console.log('Files dropped');
					const files = Array.from(e.dataTransfer.files);
					console.log('Dropped files:', files);
					if (files.length > 0) {
						uploadFiles(files);
					}
				});
				
				console.log('Upload area setup complete');
			}

			async function uploadFiles(files) {
				const progressBar = document.getElementById('progressBar');
				const progressFill = document.getElementById('progressFill');
				
				// 먼저 className을 drop-down으로 선택받습니다
				const className = await promptForClassName();
				
				// Cancel을 누른 경우 업로드 취소
				if (className === null) {
					return;
				}
				
				// className이 비어있는 경우 다시 요청
				if (!className || className.trim() === '') {
					alert('Class name is required for uploading materials.');
					return;
				}
				
				progressBar.style.display = 'block';
				
				// Show progress modal
				const progressModal = showProgressModal('Uploading files...');
				
				// 병렬 업로드를 위한 배치 처리
				const batchSize = 3; // 동시에 3개씩 업로드
				const results = [];
				
				for (let i = 0; i < files.length; i += batchSize) {
					const batch = files.slice(i, i + batchSize);
					const batchPromises = batch.map(async (file, index) => {
						const fileIndex = i + index;
						
						// 파일 검증
						if (file.size > 100 * 1024 * 1024) {
							return { success: false, file: file.name, error: 'File too large (max 100MB)' };
						}
						
						const allowedTypes = ['.pdf', '.docx', '.pptx', '.txt'];
						const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
						if (!allowedTypes.includes(fileExtension)) {
							return { success: false, file: file.name, error: 'Unsupported format' };
						}
						
						const title = file.name.replace(/\.[^/.]+$/, '');
						
						try {
							// API 호출 - 개별 파라미터로 전달
							const response = await API.materials.upload(file, title, className);
							return { success: true, file: file.name };
						} catch (error) {
							console.error('Upload error for file:', file.name, error);
							return { success: false, file: file.name, error: error.message };
						}
					});
					
					// 배치 업로드 실행
					const batchResults = await Promise.all(batchPromises);
					results.push(...batchResults);
					
					// 진행률 업데이트
					const progress = ((i + batch.length) / files.length) * 100;
					progressFill.style.width = progress + '%';
					progressModal.updateProgress(progress);
					progressModal.updateMessage(`Uploading... (${Math.min(i + batch.length, files.length)}/${files.length})`);
				}
				
				// 결과 표시
				const successCount = results.filter(r => r.success).length;
				const failCount = results.filter(r => !r.success).length;
				
				if (failCount > 0) {
					progressModal.showError(`Uploaded ${successCount} files, ${failCount} failed`);
				} else {
					progressModal.complete(`All ${successCount} files uploaded successfully!`);
				}
				
				setTimeout(() => {
					progressModal.close();
					progressBar.style.display = 'none';
					progressFill.style.width = '0%';
					document.getElementById('fileInput').value = '';
					loadMaterials();
					// Start auto-refresh to check processing status
					checkAndStartAutoRefresh();
				}, 2000);
			}

			async function promptForClassName() {
				// Get classes from Study Plan
				const savedSchedules = localStorage.getItem('studiaSchedules');
				let classes = [];
				
				if (savedSchedules) {
					const schedules = JSON.parse(savedSchedules);
					classes = [...new Set(schedules
						.filter(s => s.type === 'class')
						.map(s => s.title))];
				}
				
				return new Promise((resolve) => {
					const modal = document.createElement('div');
					modal.innerHTML = `
						<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
							<div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
								<h3 style="margin-top: 0; color: #2c3e50;">Add Class Information</h3>
								<p style="color: #666; margin-bottom: 20px;">Select or enter the class name for these materials</p>
								
								${classes.length > 0 ? `
									<label style="display: block; margin-bottom: 5px; color: #495057;">Select from your classes:</label>
									<select id="classSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
										<option value="">-- Select a class --</option>
										${classes.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
										<option value="__new__">+ Add new class</option>
									</select>
								` : ''}
								
								<div id="newClassInput" style="${classes.length > 0 ? 'display: none;' : ''}">
									<label style="display: block; margin-bottom: 5px; color: #495057;">Or enter a new class:</label>
									<input type="text" id="classNameInput" placeholder="e.g., CS101, Math 202" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
								</div>
								
								<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
									<button onclick="document.getElementById('classNameModal').resolve(null)" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer;">Cancel</button>
									<button onclick="
										const select = document.getElementById('classSelect');
										const input = document.getElementById('classNameInput');
										let value = '';
										if (select && select.value && select.value !== '__new__') {
											value = select.value;
										} else if (input && input.value) {
											value = input.value;
										}
										document.getElementById('classNameModal').resolve(value || null);
									" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer;">Continue</button>
								</div>
							</div>
						</div>
					`;
					modal.id = 'classNameModal';
					modal.resolve = (value) => {
						resolve(value);
						modal.remove();
					};
					document.body.appendChild(modal);
					
					// Add event listener for select change
					if (classes.length > 0) {
						const select = document.getElementById('classSelect');
						const newInput = document.getElementById('newClassInput');
						select.addEventListener('change', (e) => {
							if (e.target.value === '__new__') {
								newInput.style.display = 'block';
								document.getElementById('classNameInput').focus();
							} else {
								newInput.style.display = 'none';
							}
						});
					}
					
					// Focus on appropriate element
					setTimeout(() => {
						if (classes.length > 0) {
							document.getElementById('classSelect').focus();
						} else {
							document.getElementById('classNameInput').focus();
						}
					}, 100);
				});
			}

			let allMaterials = [];

			async function loadMaterials() {
				console.log('Loading materials...');
				try {
					allMaterials = await API.materials.list();
					console.log('Loaded materials:', allMaterials);
					updateClassFilter();
					filterAndDisplayMaterials();
				} catch (error) {
					console.error('Failed to load materials:', error);
					// Show error in UI
					const container = document.getElementById('materialsContainer');
					container.innerHTML = `
						<div class="empty-state">
							<i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
							<h3>Failed to load materials</h3>
							<p>${error.message}</p>
							<button class="action-btn btn-primary" onclick="location.reload()">
								<i class="fas fa-redo"></i> Reload Page
							</button>
						</div>
					`;
				}
			}

			function updateClassFilter() {
				const classFilter = document.getElementById('classFilter');
				const classes = [...new Set(allMaterials
					.filter(m => m.className)
					.map(m => m.className))];
				
				classFilter.innerHTML = '<option value="">All Classes</option>' +
					classes.map(className => 
						`<option value="${className}">${className}</option>`
					).join('');
			}

			function filterAndDisplayMaterials() {
				const container = document.getElementById('materialsContainer');
				const classFilter = document.getElementById('classFilter').value;
				const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
				
				let filteredMaterials = allMaterials;
				
				// Apply class filter
				if (classFilter) {
					filteredMaterials = filteredMaterials.filter(m => m.className === classFilter);
				}
				
				// Apply search filter
				if (searchFilter) {
					filteredMaterials = filteredMaterials.filter(m => 
						m.title.toLowerCase().includes(searchFilter) ||
						(m.summary && m.summary.toLowerCase().includes(searchFilter)) ||
						(m.className && m.className.toLowerCase().includes(searchFilter))
					);
				}
					
				if (!filteredMaterials || filteredMaterials.length === 0) {
					container.innerHTML = `
						<div class="empty-state">
							<i class="fas fa-folder-open"></i>
							<h3>No materials found</h3>
							<p>${classFilter || searchFilter ? 'Try adjusting your filters' : 'Upload your first study material to get started!'}</p>
						</div>
					`;
					return;
				}

				container.innerHTML = filteredMaterials.map(material => `
					<div class="material-card">
						<div class="material-header">
							<div>
								<h3 class="material-title">${material.title || material.originalFileName}</h3>
								<div class="material-meta">
									<span><i class="fas fa-calendar"></i> ${new Date(material.createdAt || material.uploadedAt).toLocaleDateString()}</span>
									<span><i class="fas fa-file"></i> ${formatFileSize(material.fileSize || 0)}</span>
									<span><i class="fas fa-file-alt"></i> ${material.fileType || 'Unknown'}</span>
									${material.className ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px;"><i class="fas fa-graduation-cap"></i> ${material.className}</span>` : ''}
								</div>
							</div>
							<span class="status-badge status-${(material.status || 'PROCESSING').toLowerCase()}">
								${material.status === 'COMPLETED' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-spinner fa-spin"></i>'}
								${material.status || 'PROCESSING'}
							</span>
						</div>
						
						${material.summary ? `
							<div class="summary-section">
								<h4><i class="fas fa-align-left"></i> Summary</h4>
								<div class="summary-content">${material.summary.replace(/\n/g, '<br>')}</div>
							</div>
						` : ''}
						
						${material.keyPoints ? `
							<div class="summary-section">
								<h4><i class="fas fa-list-ul"></i> Key Points</h4>
								<ul class="key-points">
									${material.keyPoints.split('\n').filter(p => p.trim()).map(point => 
										`<li>${point.replace(/^[-•*]\s*/, '')}</li>`
									).join('')}
								</ul>
							</div>
						` : ''}
						
						<div class="material-actions">
							${material.status === 'COMPLETED' ? `
								${material.fileType === 'pdf' ? 
									`<button class="action-btn btn-secondary" onclick="viewPDF(${material.id}, '${material.originalFileName}', '${API_BASE_URL}/materials/${material.id}/download')">
										<i class="fas fa-eye"></i> View PDF
									</button>` : ''
								}
								${!material.summary ? 
									`<button class="action-btn btn-primary" onclick="generateSummary(${material.id})">
										<i class="fas fa-magic"></i> Generate Summary
									</button>` : 
									`<button class="action-btn btn-secondary" onclick="regenerateSummary(${material.id})">
										<i class="fas fa-redo"></i> Regenerate
									</button>`
								}
								<button class="action-btn btn-primary" onclick="generateQuiz(${material.id})">
									❓ Create Quiz
								</button>
								<button class="action-btn btn-secondary" onclick="editMaterial(${material.id}, '${material.title}', '${material.className || ''}')">
									<i class="fas fa-edit"></i> Edit
								</button>
							` : `
								<button class="action-btn btn-secondary" disabled>
									<span class="spinner"></span> Processing...
								</button>
							`}
							<button class="action-btn btn-danger" onclick="deleteMaterial(${material.id})">
								🗑️ Delete
							</button>
						</div>
					</div>
				`).join('');
			}

			// Add event listeners for filters
			document.getElementById('classFilter').addEventListener('change', filterAndDisplayMaterials);
			document.getElementById('searchFilter').addEventListener('input', filterAndDisplayMaterials);

			async function generateSummary(materialId) {
				// Get the button element properly
				const btn = event.target.closest('button') || event.target;
				const originalHTML = btn.innerHTML;
				btn.innerHTML = '<span class="spinner"></span> Generating...';
				btn.disabled = true;
				
				// Show progress notification
				const progressNotification = showProgressNotification('Generating summary...');
				
				try {
					// 올바른 엔드포인트 사용
					const response = await fetch(`${API_BASE_URL}/materials/${materialId}/summary`, {
						method: 'POST',
						headers: {
							'Authorization': `Bearer ${TokenManager.getToken()}`
						}
					});
					
					if (!response.ok) {
						const error = await response.text();
						throw new Error(error || 'Failed to generate summary');
					}
					
					const data = await response.json();
					
					progressNotification.update('Summary generated successfully!', 'success');
					setTimeout(() => {
						progressNotification.remove();
						loadMaterials();
					}, 2000);
				} catch (error) {
					console.error('Summary generation error:', error);
					progressNotification.update('Failed to generate summary: ' + error.message, 'error');
					btn.innerHTML = originalHTML;
					btn.disabled = false;
					setTimeout(() => progressNotification.remove(), 3000);
				}
			}

			async function regenerateSummary(materialId) {
				if (!confirm('Are you sure you want to regenerate the summary?')) return;
				await generateSummary(materialId);
			}

			async function generateQuiz(materialId) {
				// 난이도 선택 모달 생성
				const modal = document.createElement('div');
				modal.innerHTML = `
					<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
						<div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
							<h3 style="margin-top: 0; color: #2c3e50;">Create Quiz</h3>
							<div style="margin-bottom: 20px;">
								<label style="display: block; margin-bottom: 5px; color: #495057;">Number of Questions:</label>
								<input type="number" id="quizCount" min="5" max="20" value="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
							</div>
							<div style="margin-bottom: 20px;">
								<label style="display: block; margin-bottom: 5px; color: #495057;">Difficulty:</label>
								<select id="quizDifficulty" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
									<option value="EASY">Easy</option>
									<option value="MEDIUM" selected>Medium</option>
									<option value="HARD">Hard</option>
								</select>
							</div>
							<div style="display: flex; gap: 10px; justify-content: flex-end;">
								<button onclick="this.closest('div').parentElement.remove()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer;">Cancel</button>
								<button onclick="confirmQuizGeneration(${materialId})" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer;">Create</button>
							</div>
						</div>
					</div>
				`;
				document.body.appendChild(modal);
			}

			async function confirmQuizGeneration(materialId) {
				const count = document.getElementById('quizCount').value;
				const difficulty = document.getElementById('quizDifficulty').value;
				
				const questionCount = parseInt(count);
				if (isNaN(questionCount) || questionCount < 5 || questionCount > 20) {
					alert('Please enter a number between 5 and 20');
					return;
				}

				// 모달 제거
				document.querySelector('[style*="position: fixed"]').remove();

				// Progress notification 표시
				const progressNotification = showProgressNotification('Creating quiz questions...');

				// 버튼 찾기 및 로딩 상태로 변경
				const btns = document.querySelectorAll('.action-btn');
				let targetBtn = null;
				btns.forEach(btn => {
					if (btn.textContent.includes('Create Quiz')) {
						targetBtn = btn;
					}
				});
				
				if (targetBtn) {
					targetBtn.innerHTML = '<span class="spinner"></span> Creating...';
					targetBtn.disabled = true;
				}

				try {
					// 퀴즈 생성 시작
					const response = await API.materials.generateQuizzes(materialId, questionCount, difficulty);
					
					// 성공하면 퀴즈 페이지로 이동
					progressNotification.update('Quiz created successfully!', 'success');
					setTimeout(() => {
						progressNotification.remove();
						window.location.href = 'quiz.html';
					}, 1500);
					
				} catch (error) {
					// 폴링으로 상태 확인 (백그라운드 처리인 경우)
					if (error.message.includes('processing')) {
						let checkCount = 0;
						const checkInterval = setInterval(async () => {
							checkCount++;
							
							try {
								const quizzes = await API.quizzes.list();
								const materialQuizzes = quizzes.filter(q => 
									q.material && q.material.id === materialId
								);
								
								// 이전 체크보다 퀴즈가 늘어났으면 성공
								if (materialQuizzes.length > 0) { 
									clearInterval(checkInterval);
									progressNotification.update('Quiz created successfully!', 'success');
									setTimeout(() => {
										progressNotification.remove();
										window.location.href = 'quiz.html';
									}, 1500);
								} else if (checkCount > 12) { // 최대 1분 대기
									clearInterval(checkInterval);
									progressNotification.update('Quiz generation timed out. Please try again.', 'error');
									if (targetBtn) {
										targetBtn.innerHTML = '<i class="fas fa-question-circle"></i> Create Quiz';
										targetBtn.disabled = false;
									}
									setTimeout(() => progressNotification.remove(), 3000);
								}
							} catch (pollError) {
								clearInterval(checkInterval);
								progressNotification.update('Failed to generate quiz: ' + pollError.message, 'error');
								if (targetBtn) {
									targetBtn.innerHTML = '<i class="fas fa-question-circle"></i> Create Quiz';
									targetBtn.disabled = false;
								}
								setTimeout(() => progressNotification.remove(), 3000);
							}
						}, 5000); // 5초마다 확인
					} else {
						// 일반 에러
						progressNotification.update('Failed to generate quiz: ' + error.message, 'error');
						if (targetBtn) {
							targetBtn.innerHTML = '<i class="fas fa-question-circle"></i> Create Quiz';
							targetBtn.disabled = false;
						}
						setTimeout(() => progressNotification.remove(), 3000);
					}
				}
			}

			async function deleteMaterial(materialId) {
				if (!confirm('Are you sure you want to delete this material? This cannot be undone.')) return;
				
				const btn = event.target.closest('button');
				const originalHTML = btn.innerHTML;
				btn.innerHTML = '<span class="spinner"></span> Deleting...';
				btn.disabled = true;
				
				try {
					const response = await API.materials.delete(materialId);
					
					// 성공 시 UI에서 즉시 제거
					const card = btn.closest('.material-card');
					card.style.opacity = '0';
					card.style.transform = 'scale(0.9)';
					
					setTimeout(() => {
						// 로컬 배열에서도 제거
						allMaterials = allMaterials.filter(m => m.id !== materialId);
						filterAndDisplayMaterials();
						showNotification('Material deleted successfully!');
					}, 300);
				} catch (error) {
					console.error('Delete error:', error);
					btn.innerHTML = originalHTML;
					btn.disabled = false;
					alert('Failed to delete material: ' + error.message);
				}
			}

			function formatFileSize(bytes) {
				if (bytes === 0) return '0 Bytes';
				const k = 1024;
				const sizes = ['Bytes', 'KB', 'MB', 'GB'];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
			}
			
			// Progress modal function
			function showProgressModal(initialMessage) {
				const modal = document.createElement('div');
				modal.style.cssText = `
					position: fixed;
					top: 0;
					left: 0;
					right: 0;
					bottom: 0;
					background: rgba(0,0,0,0.7);
					display: flex;
					align-items: center;
					justify-content: center;
					z-index: 10000;
				`;
				
				modal.innerHTML = `
					<div style="background: white; padding: 40px; border-radius: 20px; min-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
						<h3 style="margin: 0 0 20px 0; color: #2c3e50; text-align: center;">Processing</h3>
						<div style="margin-bottom: 20px;">
							<div style="background: #e9ecef; border-radius: 10px; height: 10px; overflow: hidden;">
								<div id="modalProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
							</div>
						</div>
						<div id="modalMessage" style="text-align: center; color: #495057; margin-bottom: 20px;">${initialMessage}</div>
						<div id="modalStatus" style="text-align: center; font-size: 2em;">
							<div class="spinner" style="margin: 0 auto;"></div>
						</div>
					</div>
				`;
				
				document.body.appendChild(modal);
				
				return {
					updateProgress: (percent) => {
						document.getElementById('modalProgressBar').style.width = percent + '%';
					},
					updateMessage: (message) => {
						document.getElementById('modalMessage').textContent = message;
					},
					showError: (message) => {
						document.getElementById('modalMessage').innerHTML = `<span style="color: #f44336;">${message}</span>`;
						document.getElementById('modalStatus').innerHTML = '<span style="color: #f44336;">❌</span>';
					},
					complete: (message) => {
						document.getElementById('modalProgressBar').style.width = '100%';
						document.getElementById('modalMessage').innerHTML = `<span style="color: #4caf50;">${message}</span>`;
						document.getElementById('modalStatus').innerHTML = '<span style="color: #4caf50;">✅</span>';
					},
					close: () => {
						modal.style.animation = 'fadeOut 0.3s ease';
						setTimeout(() => modal.remove(), 300);
					}
				};
			}
			
			// Notification function
			function showNotification(message, type = 'success') {
				const notification = document.createElement('div');
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					padding: 15px 25px;
					background: ${type === 'success' ? '#4caf50' : '#f44336'};
					color: white;
					border-radius: 8px;
					box-shadow: 0 4px 12px rgba(0,0,0,0.15);
					z-index: 1000;
					animation: slideIn 0.3s ease;
					max-width: 300px;
				`;
				notification.textContent = message;
				
				// Add animation
				const style = document.createElement('style');
				style.textContent = `
					@keyframes slideIn {
						from { transform: translateX(100%); opacity: 0; }
						to { transform: translateX(0); opacity: 1; }
					}
					@keyframes slideOut {
						from { transform: translateX(0); opacity: 1; }
						to { transform: translateX(100%); opacity: 0; }
					}
				`;
				document.head.appendChild(style);
				
				document.body.appendChild(notification);
				
				// Auto remove after 3 seconds
				setTimeout(() => {
					notification.style.animation = 'slideOut 0.3s ease';
					setTimeout(() => notification.remove(), 300);
				}, 3000);
			}
			
			// Progress notification
			function showProgressNotification(message) {
				const notification = document.createElement('div');
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					padding: 20px 25px;
					background: white;
					border-radius: 8px;
					box-shadow: 0 4px 20px rgba(0,0,0,0.1);
					z-index: 1000;
					animation: slideIn 0.3s ease;
					min-width: 300px;
				`;
				
				notification.innerHTML = `
					<div style="display: flex; align-items: center; gap: 15px;">
						<div class="spinner"></div>
						<div>
							<div style="font-weight: 600; color: #333; margin-bottom: 5px;">${message}</div>
							<div class="progress-bar" style="margin-top: 10px;">
								<div class="progress-fill" style="animation: progressAnimation 2s ease-in-out infinite;"></div>
							</div>
						</div>
					</div>
				`;
				
				// Add progress animation
				const style = document.createElement('style');
				style.textContent = `
					@keyframes progressAnimation {
						0% { width: 0%; }
						50% { width: 70%; }
						100% { width: 100%; }
					}
				`;
				document.head.appendChild(style);
				
				document.body.appendChild(notification);
				
				return {
					update: (newMessage, type) => {
						if (type === 'success') {
							notification.innerHTML = `
								<div style="display: flex; align-items: center; gap: 15px;">
									<div style="color: #4caf50; font-size: 1.5em;">✓</div>
									<div style="font-weight: 600; color: #333;">${newMessage}</div>
								</div>
							`;
						} else if (type === 'error') {
							notification.innerHTML = `
								<div style="display: flex; align-items: center; gap: 15px;">
									<div style="color: #f44336; font-size: 1.5em;">✗</div>
									<div style="font-weight: 600; color: #333;">${newMessage}</div>
								</div>
							`;
						} else {
							notification.querySelector('div > div > div:first-child').textContent = newMessage;
						}
					},
					remove: () => {
						notification.style.animation = 'slideOut 0.3s ease';
						setTimeout(() => notification.remove(), 300);
					}
				};
			}

			async function editMaterial(materialId, currentTitle, currentClassName) {
				// 기존 클래스 목록 가져오기
				const materials = await API.materials.list();
				const classes = new Set();
				
				materials.forEach(m => {
					if (m.className) classes.add(m.className);
				});
				
				// Study Plan에서도 클래스 가져오기
				try {
					const studyPlans = await API.studyPlans.getAll();
					studyPlans.forEach(plan => {
						if (plan.className) classes.add(plan.className);
						if (plan.type === 'class') classes.add(plan.title);
					});
				} catch (e) {
					console.log('Could not fetch study plans for class list');
				}
				
				const uniqueClasses = [...classes].sort();
				
				const modal = document.createElement('div');
				modal.innerHTML = `
					<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
						<div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
							<h3 style="margin-top: 0; color: #2c3e50;">Edit Material</h3>
							<div style="margin-bottom: 20px;">
								<label style="display: block; margin-bottom: 5px; color: #495057;">Title:</label>
								<input type="text" id="editTitle" value="${currentTitle}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
							</div>
							<div style="margin-bottom: 20px;">
								<label style="display: block; margin-bottom: 5px; color: #495057;">Class:</label>
								${uniqueClasses.length > 0 ? `
									<select id="editClassSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
										<option value="">-- Select existing class --</option>
										${uniqueClasses.map(cls => 
											`<option value="${cls}" ${cls === currentClassName ? 'selected' : ''}>${cls}</option>`
										).join('')}
										<option value="__new__">+ Add new class</option>
									</select>
								` : ''}
								<input type="text" id="editClassName" value="${currentClassName}" placeholder="Enter class name" 
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
									   ${uniqueClasses.includes(currentClassName) ? 'display: none;' : ''}">
							</div>
							<div style="display: flex; gap: 10px; justify-content: flex-end;">
								<button onclick="this.closest('div').parentElement.remove()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer;">Cancel</button>
								<button onclick="saveEditMaterial(${materialId})" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer;">Save</button>
							</div>
						</div>
					</div>
				`;
				document.body.appendChild(modal);
				
				// Add event listener for class select
				if (uniqueClasses.length > 0) {
					const select = document.getElementById('editClassSelect');
					const input = document.getElementById('editClassName');
					
					select.addEventListener('change', (e) => {
						if (e.target.value === '__new__') {
							input.style.display = 'block';
							input.value = '';
							input.focus();
						} else if (e.target.value) {
							input.style.display = 'none';
							input.value = e.target.value;
						} else {
							input.style.display = 'block';
						}
					});
				}
				
				// Focus on title input
				setTimeout(() => document.getElementById('editTitle').focus(), 100);
			}
			
			async function saveEditMaterial(materialId) {
				const title = document.getElementById('editTitle').value.trim();
				const classInput = document.getElementById('editClassName');
				const classSelect = document.getElementById('editClassSelect');
				
				let className = '';
				if (classSelect && classInput.style.display !== 'none') {
					className = classInput.value.trim();
				} else if (classSelect) {
					className = classSelect.value === '__new__' ? classInput.value.trim() : classSelect.value;
				} else {
					className = classInput.value.trim();
				}
				
				if (!title) {
					alert('Title is required');
					return;
				}
				
				// 모달 제거
				document.querySelector('[style*="position: fixed"]').remove();
				
				try {
					// API call to update material
					const response = await apiClient.put(`/materials/${materialId}`, {
						title: title,
						className: className
					});
					
					if (!response.ok) throw new Error('Failed to update material');
					
					showNotification('Material updated successfully!');
					loadMaterials();
				} catch (error) {
					showNotification('Failed to update material: ' + error.message, 'error');
				}
			}
			
			// View PDF function
			function viewPDF(materialId, fileName, pdfUrl) {
				// Open PDF viewer in new tab
				window.open(`/pdf-viewer.html?id=${materialId}`, '_blank');
			}
			
			// Auto-refresh materials every 5 seconds if any are processing
			let refreshInterval;
			
			function startAutoRefresh() {
				if (refreshInterval) return;
				
				refreshInterval = setInterval(async () => {
					try {
						const materials = await API.materials.list();
						const hasProcessing = materials.some(m => m.status === 'PROCESSING');
						
						if (hasProcessing) {
							console.log('Found materials still processing, refreshing...');
							allMaterials = materials;
							filterAndDisplayMaterials();
						} else {
							console.log('No materials processing, stopping auto-refresh');
							stopAutoRefresh();
						}
					} catch (error) {
						console.error('Auto-refresh error:', error);
					}
				}, 5000); // 10초에서 5초로 단축
			}
			
			function stopAutoRefresh() {
				if (refreshInterval) {
					clearInterval(refreshInterval);
					refreshInterval = null;
				}
			}
			
			// Check for processing materials on load
			async function checkAndStartAutoRefresh() {
				try {
					const materials = await API.materials.list();
					if (materials.some(m => m.status === 'PROCESSING')) {
						startAutoRefresh();
					}
				} catch (error) {
					console.error('Error checking materials:', error);
				}
			}
			
			// Call this after initial load
			setTimeout(checkAndStartAutoRefresh, 1000);
		</script>
		<script src="js/header-username-fix.js"></script>
</body>
</html>