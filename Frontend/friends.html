<!DOCTYPE HTML>
<html>
	<head>
		<title>Studia - Friends & Study Groups</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="css/main.css" />
		<link rel="stylesheet" href="css/fontawesome-all.min.css" />
		<link rel="stylesheet" href="css/responsive.css" />
		<link rel="stylesheet" href="css/sidebar-fixed.css" />
		<link rel="stylesheet" href="css/menu-toggle.css" />
		<link rel="stylesheet" href="css/header-final.css?v=1749757770" />		<link rel="stylesheet" href="css/dark-mode.css" />
		<link rel="stylesheet" href="css/main-responsive.css" />		<style>
			
		.friend-search {
				display: flex;
				gap: 10px;
				margin-bottom: 30px;
			}
			
			.friend-search input {
				flex: 1;
			}
			
			.friends-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 20px;
			}
			
			.friend-card {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 10px;
				display: flex;
				align-items: center;
				gap: 15px;
				transition: all 0.3s;
			}
			
			.friend-card:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 15px rgba(0,0,0,0.1);
			}
			
			.friend-avatar {
				width: 60px;
				height: 60px;
				border-radius: 50%;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-size: 1.5em;
				font-weight: bold;
				overflow: hidden;
			}
			
			.friend-info {
				flex: 1;
			}
			
			.friend-name {
				font-weight: 600;
				color: #2c3e50;
				margin-bottom: 5px;
			}
			
			.friend-status {
				font-size: 0.9em;
				color: #6c757d;
			}
			
			.friend-actions {
				display: flex;
				gap: 5px;
				align-items: center;
			}
			
			.friend-actions button {
				padding: 5px 10px;
				font-size: 0.85em;
			}
			
			/* Study Groups */
			.group-card {
				background: white;
				border-radius: 15px;
				padding: 25px;
				box-shadow: 0 5px 15px rgba(0,0,0,0.08);
				margin-bottom: 20px;
				transition: all 0.3s;
			}
			
			.group-card:hover {
				transform: translateY(-3px);
				box-shadow: 0 8px 25px rgba(0,0,0,0.12);
			}
			
			.group-header {
				display: flex;
				justify-content: space-between;
				align-items: start;
				margin-bottom: 15px;
			}
			
			.group-title {
				font-size: 1.3em;
				font-weight: 600;
				color: #2c3e50;
				margin: 0;
			}
			
			.group-meta {
				display: flex;
				gap: 20px;
				margin: 10px 0;
				color: #6c757d;
				font-size: 0.9em;
			}
			
			.group-meta span {
				display: flex;
				align-items: center;
				gap: 5px;
			}
			
			.group-description {
				color: #495057;
				margin-bottom: 15px;
				line-height: 1.6;
			}
			
			.group-members {
				display: flex;
				align-items: center;
				gap: -10px;
				margin-bottom: 15px;
			}
			
			.member-avatar {
				width: 35px;
				height: 35px;
				border-radius: 50%;
				background: #667eea;
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 0.9em;
				border: 2px solid white;
				position: relative;
			}
			
			.member-count {
				margin-left: 20px;
				color: #6c757d;
				font-size: 0.9em;
			}
			
			/* Chat Preview */
			.chat-section {
				background: white;
				border-radius: 15px;
				padding: 20px;
				margin-top: 30px;
			}
			
			.chat-list {
				max-height: 400px;
				overflow-y: auto;
			}
			
			.chat-item {
				padding: 15px;
				border-bottom: 1px solid #e9ecef;
				cursor: pointer;
				transition: background 0.2s;
			}
			
			.chat-item:hover {
				background: #f8f9fa;
			}
			
			.chat-item:last-child {
				border-bottom: none;
			}
			
			.chat-header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 5px;
			}
			
			.chat-sender {
				font-weight: 600;
				color: #2c3e50;
			}
			
			.chat-time {
				font-size: 0.85em;
				color: #6c757d;
			}
			
			.chat-message {
				color: #495057;
				font-size: 0.95em;
			}
			
			/* Request Card */
			.request-card {
				background: #e3f2fd;
				border: 1px solid #1976d2;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 10px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			
			.request-info {
				flex: 1;
			}
			
			.request-actions {
				display: flex;
				gap: 10px;
			}
			
			/* Tabs */
			.social-tabs {
				display: flex;
				gap: 10px;
				margin-bottom: 30px;
				border-bottom: 2px solid #e9ecef;
			}
			
			.social-tab {
				padding: 10px 20px;
				background: none;
				border: none;
				color: #6c757d;
				cursor: pointer;
				font-weight: 500;
				position: relative;
				transition: color 0.3s;
			}
			
			.social-tab:hover {
				color: #495057;
			}
			
			.social-tab.active {
				color: #f56a6a;
			}
			
			.social-tab.active::after {
				content: '';
				position: absolute;
				bottom: -2px;
				left: 0;
				right: 0;
				height: 2px;
				background: #f56a6a;
			}
			
			.tab-content {
				display: none;
			}
			
			.tab-content.active {
				display: block;
			}
		
                  /* 아이콘 컨테이너 중앙 정렬 */
                  .menu-toggle-btn i {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        width: 100%;
                        height: 100%;
                        position: relative;
                  }
                  
                  /* 햄버거 메뉴 라인 위치 조정 */
                  .menu-toggle-btn span,
                  .menu-toggle-btn i::before,
                  .menu-toggle-btn i::after {
                        position: absolute;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 20px;
                        height: 2px;
                        background-color: white;
                        transition: all 0.3s ease;
                  }
                  
                  .menu-toggle-btn span {
                        top: 50%;
                        transform: translate(-50%, -50%);
                  }
                  
                  .menu-toggle-btn i::before {
                        content: '';
                        top: calc(50% - 6px);
                  }
                  
                  .menu-toggle-btn i::after {
                        content: '';
                        top: calc(50% + 4px);
                  }
                  
                  /* 사이드바가 열려있을 때 X 모양으로 변형 */
                  body:not(.sidebar-inactive) .menu-toggle-btn span {
                        opacity: 0;
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::before {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(45deg);
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::after {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                  }
                
                  /* 아이콘 컨테이너 중앙 정렬 */
                  .menu-toggle-btn i {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        width: 100%;
                        height: 100%;
                        position: relative;
                  }
                  
                  /* 햄버거 메뉴 라인 위치 조정 */
                  .menu-toggle-btn span,
                  .menu-toggle-btn i::before,
                  .menu-toggle-btn i::after {
                        position: absolute;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 20px;
                        height: 2px;
                        background-color: white;
                        transition: all 0.3s ease;
                  }
                  
                  .menu-toggle-btn span {
                        top: 50%;
                        transform: translate(-50%, -50%);
                  }
                  
                  .menu-toggle-btn i::before {
                        content: '';
                        top: calc(50% - 6px);
                  }
                  
                  .menu-toggle-btn i::after {
                        content: '';
                        top: calc(50% + 4px);
                  }
                  
                  /* 사이드바가 열려있을 때 X 모양으로 변형 */
                  body:not(.sidebar-inactive) .menu-toggle-btn span {
                        opacity: 0;
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::before {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(45deg);
                  }
                  
                  body:not(.sidebar-inactive) .menu-toggle-btn i::after {
                        top: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                  }
                </style>
	</head>
	<body class="is-preload">
		<!-- Menu Toggle Button -->
		<button class="menu-toggle-btn" onclick="toggleSidebar()">
			<i><span></span></i>
		</button>
		
		<!-- Wrapper -->
		<div id="wrapper">
			<!-- Main -->
			<div id="main">
				<div class="inner">
					                <!-- Header -->
                <header id="header">
                    <a href="index.html" class="logo">
                        <strong style="font-size: 2em;">Studia</strong>
                    </a>
                    <ul class="icons header-user-info">
                        <li><span id="userWelcome" data-username="">Welcome!</span></li>
                        <li><a href="#" onclick="logout()" class="button small logout-btn">Logout</a></li>
                    </ul>
                </header>

					<!-- Content -->
					<section>
						<header class="main">
							<h1>Friends & Study Groups</h1>
							<p>Connect with classmates and study together</p>
						</header>

						<!-- Tabs -->
						<div class="social-tabs">
							<button class="social-tab active" onclick="switchTab('friends')">
								<i class="fas fa-user-friends"></i> Friends
							</button>
							<button class="social-tab" onclick="switchTab('groups')">
								<i class="fas fa-users"></i> Study Groups
							</button>
							<button class="social-tab" onclick="switchTab('requests')">
								<i class="fas fa-user-plus"></i> Requests
								<span id="requestBadge" style="background: #f56a6a; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 5px; display: none;">0</span>
							</button>
						</div>

						<!-- Friends Tab -->
						<div id="friendsTab" class="tab-content active">
							<div class="friends-section">
								<h3>Find Friends</h3>
								<div class="friend-search">
									<input type="text" placeholder="Search by name or email..." id="friendSearchInput">
									<button class="button primary" onclick="searchFriends()">
										<i class="fas fa-search"></i> Search
									</button>
								</div>
								
								<div id="searchResults" style="display: none;">
									<h4>Search Results</h4>
									<div id="searchResultsList" class="friends-grid">
										<!-- Search results will appear here -->
									</div>
								</div>
							</div>

							<div class="friends-section">
								<h3>Recommended Friends</h3>
								<p style="color: #6c757d; margin-bottom: 20px;">People you may know based on mutual friends and interests</p>
								<div id="recommendedFriends" class="friends-grid">
									<div style="grid-column: 1/-1; text-align: center; padding: 20px;">
										<i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #6c757d;"></i>
									</div>
								</div>
							</div>

							<div class="friends-section">
								<h3>My Friends</h3>
								<div id="friendsList" class="friends-grid">
									<!-- Friends will be loaded here -->
								</div>
							</div>
						</div>

						<!-- Groups Tab -->
						<div id="groupsTab" class="tab-content">
							<div style="margin-bottom: 30px;">
								<button class="button primary" onclick="createNewGroup()">
									<i class="fas fa-plus"></i> Create Study Group
								</button>
							</div>

							<h3>My Study Groups</h3>
							<div id="myGroups">
								<!-- User's groups will be loaded here -->
							</div>

							<h3 style="margin-top: 40px;">Discover Groups</h3>
							<div id="discoverGroups">
								<!-- Available groups will be loaded here -->
							</div>
						</div>

						<!-- Requests Tab -->
						<div id="requestsTab" class="tab-content">
							<h3>Friend Requests</h3>
							<div id="friendRequests">
								<!-- Friend requests will be loaded here -->
							</div>

							<h3 style="margin-top: 30px;">Group Invitations</h3>
							<div id="groupInvitations">
								<!-- Group invitations will be loaded here -->
							</div>
						</div>

						<!-- Recent Messages -->
						<div class="chat-section">
							<h3>Recent Messages</h3>
							<div class="chat-list" id="recentMessages">
								<div class="empty-state" style="text-align: center; padding: 40px; color: #6c757d;">
									<i class="fas fa-comments" style="font-size: 3em; margin-bottom: 10px;"></i>
									<p>No messages yet. Start chatting with your study groups!</p>
								</div>
							</div>
						</div>
					</section>
				</div>
			</div>

			<!-- Sidebar -->
			<div id="sidebar">
				<div class="inner">
					<!-- Menu -->
					<nav id="menu">
						<header class="major">
							<h2>Menu</h2>
						</header>
						<ul>
							<li><a href="index.html">Main</a></li>
							<li><a href="summary.html">Summary</a></li>
							<li><a href="quiz.html">Quiz</a></li>
							<li><a href="plan.html">Study Plan</a></li>
							<li><a href="dashboard.html">Dashboard</a></li>
							<li><a href="leaderboard.html">Leaderboard</a></li>
							<li><a href="friends.html">Friends</a></li>
							<li><a href="profile.html">My Page</a></li>
						</ul>
					</nav>

					<!-- Section -->
					<section>
						<header class="major">
							<h2>Study Tips</h2>
						</header>
						<p><strong>Collaborative Learning:</strong><br>
						• Form study groups of 3-5 people<br>
						• Take turns explaining concepts<br>
						• Quiz each other regularly<br>
						• Share notes and resources</p>
					</section>

					<!-- Footer -->
					<footer id="footer"></footer>
				</div>
			</div>
		</div>

		<!-- Scripts -->
		<script src="js/jquery.min.js"></script>
		<script src="js/browser.min.js"></script>
		<script src="js/breakpoints.min.js"></script>
		<script src="js/util.js"></script>
		<script src="js/main.js"></script>
		<script src="assets/js/api.js"></script>
		<script src="js/header-username.js"></script>
		<script src="js/sidebar-toggle-global.js"></script>
		<script src="js/dark-mode.js"></script>
		<script src="js/sidebar-state.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

		<script>
			let stompClient = null;
			let currentUserId = null;
			let notificationCount = 0;
			
			// Toggle Sidebar Function
			function toggleSidebar() {
				const sidebar = document.getElementById('sidebar');
				sidebar.classList.toggle('inactive');
				document.body.classList.toggle('sidebar-inactive');
			}
			
			// Page initialization
			document.addEventListener('DOMContentLoaded', async function() {
				// Set initial sidebar state
				const sidebar = document.getElementById('sidebar');
				sidebar.classList.add('inactive');
				document.body.classList.add('sidebar-inactive');

				if (!checkAuth()) {
					alert('Please login first');
					window.location.href = '/';
					return;
				}

				updateHeader();
				await loadFriends();
				await loadRecommendations();
				await loadGroups();
				await checkRequests();
				
				// Connect to WebSocket for real-time notifications
				connectWebSocket();
			});
			
			// WebSocket connection
			function connectWebSocket() {
				currentUserId = TokenManager.getUserId();
				
				const socket = new SockJS('http://localhost:8080/ws');
				stompClient = Stomp.over(socket);
				
				// Disable debug logs
				stompClient.debug = null;
				
				stompClient.connect({
					'Authorization': 'Bearer ' + TokenManager.getToken()
				}, function(frame) {
					console.log('Connected to WebSocket for notifications');
					
					// Subscribe to personal notifications
					stompClient.subscribe(`/topic/user/${currentUserId}/notifications`, function(notification) {
						const data = JSON.parse(notification.body);
						handleNotification(data);
					});
					
					// Subscribe to friend updates
					stompClient.subscribe(`/topic/user/${currentUserId}/friends`, function(update) {
						const data = JSON.parse(update.body);
						if (data.type === 'FRIEND_REQUEST' || data.type === 'FRIEND_ACCEPTED') {
							loadFriends();
							checkRequests();
						}
					});
					
					// Subscribe to group updates
					stompClient.subscribe(`/topic/user/${currentUserId}/groups`, function(update) {
						const data = JSON.parse(update.body);
						if (data.type === 'GROUP_INVITE' || data.type === 'GROUP_JOINED') {
							loadGroups();
							checkRequests();
						}
					});
					
				}, function(error) {
					console.error('WebSocket connection error:', error);
					setTimeout(connectWebSocket, 5000); // Retry after 5 seconds
				});
			}
			
			// Handle notifications
			function handleNotification(data) {
				console.log('Received notification:', data);
				
				// Show browser notification if permitted
				if ('Notification' in window && Notification.permission === 'granted') {
					new Notification('Studia', {
						body: data.message,
						icon: '/favicon.ico',
						tag: data.type
					});
				}
				
				// Update UI based on notification type
				switch(data.type) {
					case 'FRIEND_REQUEST':
						incrementRequestBadge();
						showToast('New friend request from ' + data.fromUser);
						checkRequests();
						break;
					case 'GROUP_INVITE':
						incrementRequestBadge();
						showToast('New group invitation');
						checkRequests();
						break;
					case 'NEW_MESSAGE':
						showToast('New message in ' + data.groupName);
						updateRecentMessages();
						break;
				}
			}
			
			// Show toast notification
			function showToast(message) {
				// Create toast element
				const toast = document.createElement('div');
				toast.style.cssText = `
					position: fixed;
					bottom: 20px;
					right: 20px;
					background: #333;
					color: white;
					padding: 15px 20px;
					border-radius: 8px;
					box-shadow: 0 4px 12px rgba(0,0,0,0.15);
					z-index: 10000;
					animation: slideIn 0.3s ease;
				`;
				toast.textContent = message;
				document.body.appendChild(toast);
				
				// Remove after 3 seconds
				setTimeout(() => {
					toast.style.animation = 'slideOut 0.3s ease';
					setTimeout(() => toast.remove(), 300);
				}, 3000);
			}
			
			// Add CSS animation
			const style = document.createElement('style');
			style.textContent = `
				@keyframes slideIn {
					from { transform: translateX(100%); opacity: 0; }
					to { transform: translateX(0); opacity: 1; }
				}
				@keyframes slideOut {
					from { transform: translateX(0); opacity: 1; }
					to { transform: translateX(100%); opacity: 0; }
				}
			`;
			document.head.appendChild(style);
			
			// Increment request badge
			function incrementRequestBadge() {
				notificationCount++;
				const badge = document.getElementById('requestBadge');
				badge.textContent = notificationCount;
				badge.style.display = 'inline-block';
			}
			
			// Update recent messages
			async function updateRecentMessages() {
				try {
					// In a real implementation, fetch recent messages from API
					const recentMessages = document.getElementById('recentMessages');
					// Update UI with new messages
				} catch (error) {
					console.error('Error updating messages:', error);
				}
			}
			
			// Disconnect WebSocket on page unload
			window.addEventListener('beforeunload', () => {
				if (stompClient && stompClient.connected) {
					stompClient.disconnect();
				}
			});

			function updateHeader() {
                const username = TokenManager.getUsername();
                const userWelcome = document.getElementById('userWelcome');
                if (userWelcome) {
                    userWelcome.textContent = `Welcome, ${username || 'User'}!`;
                    userWelcome.setAttribute('data-username', username || 'User');
                }
            }!`;
            }!</span></li>
					<li><button class="button" onclick="logout()">Log Out</button></li>
				`;
			}

			function logout() {
				if (stompClient && stompClient.connected) {
					stompClient.disconnect();
				}
				API.auth.logout();
			}

			// Tab switching
			function switchTab(tabName) {
				// Update tab buttons
				document.querySelectorAll('.social-tab').forEach(tab => {
					tab.classList.remove('active');
				});
				event.target.classList.add('active');
				
				// Update tab content
				document.querySelectorAll('.tab-content').forEach(content => {
					content.classList.remove('active');
				});
				document.getElementById(tabName + 'Tab').classList.add('active');
			}

			// Load friends from API
			async function loadFriends() {
				const friendsList = document.getElementById('friendsList');
				
				try {
					const response = await API.friends.getFriends();
					const friends = response.data || [];
					
					if (friends.length === 0) {
						friendsList.innerHTML = `
							<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
								<i class="fas fa-user-friends" style="font-size: 3em; margin-bottom: 10px;"></i>
								<p>No friends yet. Search and add friends to get started!</p>
							</div>
						`;
						return;
					}
					
					friendsList.innerHTML = friends.map(friend => `
						<div class="friend-card">
							<div class="friend-avatar">${friend.profileImage ? 
								`<img src="${friend.profileImage}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
								friend.name.charAt(0).toUpperCase()}</div>
							<div class="friend-info">
								<div class="friend-name">${friend.name}</div>
								<div class="friend-status">${friend.statusMessage || friend.email}</div>
							</div>
							<div class="friend-actions">
								<button class="button small" onclick="messageUser(${friend.id})">
									<i class="fas fa-comment"></i>
								</button>
								<button class="button small" onclick="viewProfile(${friend.id})">
									<i class="fas fa-user"></i>
								</button>
							</div>
						</div>
					`).join('');
				} catch (error) {
					console.error('Error loading friends:', error);
					friendsList.innerHTML = '<p>Error loading friends. Please try again.</p>';
				}
			}

			// Load friend recommendations
			async function loadRecommendations() {
				const recommendedFriends = document.getElementById('recommendedFriends');
				
				try {
					const response = await API.friends.getRecommendations(6); // Get 6 recommendations
					const recommendations = response || [];
					
					if (recommendations.length === 0) {
						recommendedFriends.innerHTML = `
							<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6c757d;">
								<p>No recommendations available at the moment.</p>
							</div>
						`;
						return;
					}
					
					recommendedFriends.innerHTML = recommendations.map(user => `
						<div class="friend-card">
							<div class="friend-avatar">${user.profileImage ? 
								`<img src="${user.profileImage}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
								user.name.charAt(0).toUpperCase()}</div>
							<div class="friend-info">
								<div class="friend-name">${user.name}</div>
								<div class="friend-status">${user.email}</div>
								${user.mutualFriendsCount > 0 ? 
									`<div style="font-size: 0.85em; color: #667eea; margin-top: 5px;">
										<i class="fas fa-user-friends"></i> ${user.mutualFriendsCount} mutual friend${user.mutualFriendsCount > 1 ? 's' : ''}
									</div>` : ''
								}
							</div>
							<div class="friend-actions">
								<button class="button small primary" onclick="sendFriendRequest(${user.id})">
									<i class="fas fa-user-plus"></i> Add
								</button>
							</div>
						</div>
					`).join('');
				} catch (error) {
					console.error('Error loading recommendations:', error);
					recommendedFriends.innerHTML = `
						<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6c757d;">
							<p>Could not load recommendations.</p>
						</div>
					`;
				}
			}

			// Load groups from API
			async function loadGroups() {
				const myGroups = document.getElementById('myGroups');
				const discoverGroups = document.getElementById('discoverGroups');
				
				try {
					// Load my groups
					const myGroupsResponse = await API.groups.getMyGroups();
					const userGroups = myGroupsResponse.data || [];
					
					if (userGroups.length > 0) {
						myGroups.innerHTML = userGroups.map(group => createGroupCard(group, true)).join('');
					} else {
						myGroups.innerHTML = '<p style="color: #6c757d;">You haven\'t joined any groups yet.</p>';
					}
					
					// Load public groups
					const publicGroupsResponse = await API.groups.getPublicGroups();
					const publicGroups = publicGroupsResponse.data || [];
					
					// Filter out groups user is already in
					const availableGroups = publicGroups.filter(
						group => !userGroups.some(myGroup => myGroup.id === group.id)
					);
					
					if (availableGroups.length > 0) {
						discoverGroups.innerHTML = availableGroups.map(group => createGroupCard(group, false)).join('');
					} else {
						discoverGroups.innerHTML = '<p style="color: #6c757d;">No available groups to join.</p>';
					}
				} catch (error) {
					console.error('Error loading groups:', error);
					myGroups.innerHTML = '<p>Error loading groups. Please try again.</p>';
				}
			}

			function createGroupCard(group, isMember) {
				return `
					<div class="group-card">
						<div class="group-header">
							<div>
								<h3 class="group-title">${group.name}</h3>
								<div class="group-meta">
									${group.courseName ? `<span><i class="fas fa-book"></i> ${group.courseName}</span>` : ''}
									<span><i class="fas fa-users"></i> ${group.memberCount}/${group.maxMembers} members</span>
									<span><i class="fas fa-user"></i> ${group.ownerName}</span>
								</div>
							</div>
							${isMember ? 
								`<button class="button small" onclick="openGroupChat(${group.id})">
									<i class="fas fa-comments"></i> Chat
								</button>` :
								`<button class="button small primary" onclick="joinGroup(${group.id})">
									<i class="fas fa-plus"></i> Join
								</button>`
							}
						</div>
						${group.description ? `<p class="group-description">${group.description}</p>` : ''}
					</div>
				`;
			}

			// Search friends
			async function searchFriends() {
				const searchTerm = document.getElementById('friendSearchInput').value.trim();
				if (!searchTerm) return;
				
				const searchResults = document.getElementById('searchResults');
				const searchResultsList = document.getElementById('searchResultsList');
				
				try {
					const response = await API.friends.searchUsers(searchTerm);
					const users = response.data || [];
					
					searchResults.style.display = 'block';
					
					if (users.length === 0) {
						searchResultsList.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #6c757d;">No users found.</p>';
						return;
					}
					
					searchResultsList.innerHTML = users.map(user => `
						<div class="friend-card">
							<div class="friend-avatar">${user.profileImage ? 
								`<img src="${user.profileImage}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
								user.name.charAt(0).toUpperCase()}</div>
							<div class="friend-info">
								<div class="friend-name">${user.name}</div>
								<div class="friend-status">${user.email}</div>
							</div>
							<div class="friend-actions">
								${user.isFriend ? 
									`<span style="color: #4caf50;"><i class="fas fa-check"></i> Friend</span>` :
									user.hasPendingRequest ?
										(user.requestSentByMe ? 
											`<span style="color: #ff9800;"><i class="fas fa-clock"></i> Pending</span>` :
											`<button class="button small" disabled>Request Received</button>`
										) :
										`<button class="button small primary" onclick="sendFriendRequest(${user.id})">
											<i class="fas fa-user-plus"></i> Add
										</button>`
								}
							</div>
						</div>
					`).join('');
				} catch (error) {
					console.error('Error searching users:', error);
					alert('Error searching users. Please try again.');
				}
			}

			// Check for pending requests
			async function checkRequests() {
				try {
					const response = await API.friends.getRequests();
					const data = response.data || {};
					const requests = data.requests || [];
					const count = data.count || 0;
					
					if (count > 0) {
						const badge = document.getElementById('requestBadge');
						badge.textContent = count;
						badge.style.display = 'inline-block';
						
						// Load friend requests
						const friendRequests = document.getElementById('friendRequests');
						if (requests.length > 0) {
							friendRequests.innerHTML = requests.map(request => `
								<div class="request-card">
									<div class="request-info">
										<strong>${request.name}</strong> wants to be your friend
									</div>
									<div class="request-actions">
										<button class="button small primary" onclick="acceptRequest(${request.requestId})">Accept</button>
										<button class="button small" onclick="declineRequest(${request.requestId})">Decline</button>
									</div>
								</div>
							`).join('');
						} else {
							friendRequests.innerHTML = '<p style="color: #6c757d;">No pending friend requests.</p>';
						}
					}
					
					// Group invitations would be loaded here in a full implementation
					const groupInvitations = document.getElementById('groupInvitations');
					groupInvitations.innerHTML = '<p style="color: #6c757d;">No pending group invitations.</p>';
					
				} catch (error) {
					console.error('Error checking requests:', error);
				}
			}

			// Action functions
			async function sendFriendRequest(userId) {
				try {
					await API.friends.sendRequest(userId);
					alert('Friend request sent!');
					await searchFriends(); // Refresh search results
				} catch (error) {
					console.error('Error sending friend request:', error);
					alert(error.response?.data?.error || 'Error sending friend request');
				}
			}

			function messageUser(userId) {
				alert('Chat feature coming soon!');
			}

			function viewProfile(userId) {
				alert('Profile view coming soon!');
			}

			async function joinGroup(groupId) {
				try {
					await API.groups.joinGroup(groupId);
					alert('Successfully joined the group!');
					await loadGroups(); // Refresh groups
				} catch (error) {
					console.error('Error joining group:', error);
					alert(error.response?.data?.error || 'Error joining group');
				}
			}

			function openGroupChat(groupId) {
				// In a real implementation, this would open a chat window
				window.location.href = `/group-chat.html?id=${groupId}`;
			}

			async function createNewGroup() {
				const name = prompt('Enter group name:');
				if (!name) return;
				
				const description = prompt('Enter group description (optional):');
				const isPublic = confirm('Make this group public?');
				
				try {
					await API.groups.createGroup({
						name: name,
						description: description || '',
						isPublic: isPublic,
						maxMembers: 20
					});
					alert('Group created successfully!');
					await loadGroups();
				} catch (error) {
					console.error('Error creating group:', error);
					alert(error.response?.data?.error || 'Error creating group');
				}
			}

			async function acceptRequest(requestId) {
				try {
					await API.friends.acceptRequest(requestId);
					alert('Friend request accepted!');
					await loadFriends();
					await checkRequests();
				} catch (error) {
					console.error('Error accepting request:', error);
					alert(error.response?.data?.error || 'Error accepting request');
				}
			}

			async function declineRequest(requestId) {
				try {
					await API.friends.declineRequest(requestId);
					alert('Friend request declined');
					await checkRequests();
				} catch (error) {
					console.error('Error declining request:', error);
					alert(error.response?.data?.error || 'Error declining request');
				}
			}

			function acceptInvitation(invitationId) {
				alert('Group invitations coming soon!');
			}

			function declineInvitation(invitationId) {
				alert('Group invitations coming soon!');
			}
		</script>
		</body>
</html>
